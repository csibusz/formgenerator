<!-- csibusz -->
<!doctype html>
<html lang="hu" data-bs-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FormBuilder ‚Äî Bootstrap 5 Modern Form Gener√°tor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{--glass-bg:rgba(255,255,255,.06);--glass-bd:rgba(255,255,255,.12)}
    body{min-height:100vh;background:radial-gradient(1200px 600px at 10% -20%,rgba(123,97,255,.18),transparent),
         radial-gradient(1200px 600px at 110% 120%,rgba(0,255,168,.12),transparent)}
    .glass{background:var(--glass-bg);border:1px solid var(--glass-bd);backdrop-filter:saturate(140%) blur(6px)}
    .panel{border-radius:1rem}
    .palette-item{transition:.15s;cursor:pointer}
    .palette-item:hover{transform:translateY(-2px)}
    .canvas-drop{min-height:220px;border:2px dashed var(--glass-bd);border-radius:1rem}
    .field-card{cursor:grab;}
    .field-card.dragging{opacity:.6}
    .prop-label{font-size:.85rem;color:var(--bs-secondary)}
    .codebox{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;white-space:pre;min-height:240px}
    .btn-icon{display:inline-flex;align-items:center;gap:.4rem}
    .w-36{width:36px}
    .form-title-input{font-weight:700;font-size:1.1rem}
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg glass border-bottom sticky-top">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#"><i class="bi bi-braces"></i> <span data-i18n="appName">FormBuilder</span></a>
    <div class="d-flex align-items-center gap-2 ms-auto">
      <select id="langSelect" class="form-select form-select-sm w-auto me-2" title="Language">
        <option value="hu">üá≠üá∫ Magyar</option>
        <option value="en">üá¨üáß English</option>
        <option value="fr">üá´üá∑ Fran√ßais</option>
        <option value="de">üá©üá™ Deutsch</option>
      </select>
      <button id="btn-new" class="btn btn-sm btn-outline-secondary btn-icon" title="New"><i class="bi bi-file-earmark"></i><span data-i18n="newBtn">√öj</span></button>
      <button id="btn-preview" class="btn btn-sm btn-outline-primary btn-icon" title="Preview"><i class="bi bi-eye"></i><span data-i18n="previewBtn">El≈ën√©zet</span></button>
      <button id="btn-generate" class="btn btn-sm btn-primary btn-icon" title="Generate code"><i class="bi bi-code"></i><span data-i18n="generateBtn">Gener√°l√°s</span></button>
      <div class="form-check form-switch ms-2">
        <input class="form-check-input" type="checkbox" role="switch" id="themeSwitch">
        <label class="form-check-label" for="themeSwitch"><i class="bi bi-sun"></i></label>
      </div>
    </div>
  </div>
</nav>

<div class="container-fluid py-3">
  <div class="row g-3">

    <!-- Palette -->
    <div class="col-12 col-md-3 col-lg-2">
      <div class="glass panel p-3">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h6 class="m-0" data-i18n="fields">Mez≈ëk</h6>
          <span class="text-secondary small" data-i18n="dragDrop">H√∫zd & Dobd</span>
        </div>
        <div id="palette" class="row g-2"><!-- palette buttons --></div>
        <hr>
        <div class="mb-2"><span class="prop-label d-block" data-i18n="formTitle">≈∞rlap c√≠me</span>
          <input id="formTitle" class="form-control form-title-input" value="Kapcsolatfelv√©tel">
        </div>
        <div class="row g-2">
          <div class="col-6"><span class="prop-label d-block" data-i18n="action">Action</span>
            <input id="formAction" class="form-control" placeholder="/req/submit.php">
          </div>
          <div class="col-6"><span class="prop-label d-block" data-i18n="method">M√≥dszer</span>
            <select id="formMethod" class="form-select"><option>POST</option><option>GET</option></select>
          </div>
          <div class="col-6"><div class="form-check mt-2">
            <input id="ajaxSubmit" class="form-check-input" type="checkbox" checked>
            <label class="form-check-label" for="ajaxSubmit" data-i18n="ajaxSubmit">AJAX k√ºld√©s</label>
          </div></div>
          <div class="col-6"><div class="form-check mt-2">
            <input id="clientValidate" class="form-check-input" type="checkbox" checked>
            <label class="form-check-label" for="clientValidate" data-i18n="clientValidate">Kliens valid√°ci√≥</label>
          </div></div>
          <div class="col-12">
            <span class="prop-label d-block" data-i18n="theme">T√©ma</span>
            <select id="formTheme" class="form-select">
              <option value="default" data-i18n="themeDefault">Alap√©rtelmezett</option>
              <option value="glass" data-i18n="themeGlass">√úveges (glass)</option>
              <option value="soft" data-i18n="themeSoft">L√°gy (soft)</option>
              <option value="bordered" data-i18n="themeBorder">K√∂rvonalas (bordered)</option>
              <option value="underline" data-i18n="themeUnderline">Al√°h√∫zott (underline)</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Canvas -->
    <div class="col-12 col-md-6 col-lg-7">
      <div class="glass panel p-3">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h6 class="m-0" data-i18n="formEditor">≈∞rlap szerkeszt≈ë</h6>
          <div class="text-secondary small" data-i18n="sortHint">Rendez√©s: drag & drop ‚Ä¢ Katt szerkeszt</div>
        </div>
        <div id="canvas" class="canvas-drop p-2"></div>
      </div>
    </div>

    <!-- Properties & Export -->
    <div class="col-12 col-md-3 col-lg-3">
      <div class="glass panel p-3 mb-3">
        <h6 class="mb-2" data-i18n="properties">Tulajdons√°gok</h6>
        <div id="propPanel" class="text-secondary small" data-i18n="selectAField">V√°lassz ki egy mez≈ët‚Ä¶</div>
      </div>
      <div class="glass panel p-3">
        <ul class="nav nav-tabs" id="exportTabs" role="tablist">
          <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#codeHtml" type="button" data-i18n="tabHtml">HTML</button></li>
          <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#codeJs" type="button" data-i18n="tabJs">JS</button></li>
          <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#codeJson" type="button" data-i18n="tabJson">JSON</button></li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane fade show active" id="codeHtml">
            <div class="d-flex gap-2 my-2">
              <button id="copyHtml" class="btn btn-sm btn-outline-secondary"><i class="bi bi-clipboard"></i> <span data-i18n="copy">M√°sol</span></button>
              <button id="downloadHtml" class="btn btn-sm btn-outline-secondary"><i class="bi bi-download"></i> <span data-i18n="download">Let√∂lt</span></button>
            </div>
            <textarea id="outHtml" class="form-control codebox" spellcheck="false"></textarea>
          </div>
          <div class="tab-pane fade" id="codeJs">
            <div class="d-flex gap-2 my-2">
              <button id="copyJs" class="btn btn-sm btn-outline-secondary"><i class="bi bi-clipboard"></i> <span data-i18n="copy">M√°sol</span></button>
            </div>
            <textarea id="outJs" class="form-control codebox" spellcheck="false"></textarea>
          </div>
          <div class="tab-pane fade" id="codeJson">
            <div class="d-flex gap-2 my-2">
              <button id="copyJson" class="btn btn-sm btn-outline-secondary"><i class="bi bi-clipboard"></i> <span data-i18n="copy">M√°sol</span></button>
              <button id="loadJson" class="btn btn-sm btn-outline-secondary"><i class="bi bi-upload"></i> <span data-i18n="load">Bet√∂lt</span></button>
              <button id="downloadJson" class="btn btn-sm btn-outline-secondary"><i class="bi bi-download"></i> <span data-i18n="download">Let√∂lt</span></button>
            </div>
            <textarea id="outJson" class="form-control codebox" spellcheck="false"></textarea>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content glass">
      <div class="modal-header">
        <h5 class="modal-title" data-i18n="previewTitle">El≈ën√©zet</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="previewMount"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="close">Bez√°r</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
  <div id="toast" class="toast align-items-center text-bg-dark border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastBody">M≈±velet k√©sz.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script>
(() => {
  // ===== i18n =====
  const i18n = {
    hu: {
      appName:'FormBuilder', newBtn:'√öj', previewBtn:'El≈ën√©zet', generateBtn:'Gener√°l√°s',
      fields:'Mez≈ëk', dragDrop:'H√∫zd & Dobd', formTitle:'≈∞rlap c√≠me', action:'Action', method:'M√≥dszer',
      ajaxSubmit:'AJAX k√ºld√©s', clientValidate:'Kliens valid√°ci√≥', formEditor:'≈∞rlap szerkeszt≈ë', sortHint:'Rendez√©s: drag & drop ‚Ä¢ Katt szerkeszt',
      properties:'Tulajdons√°gok', selectAField:'V√°lassz ki egy mez≈ët‚Ä¶', tabHtml:'HTML', tabJs:'JS', tabJson:'JSON', copy:'M√°sol', download:'Let√∂lt', load:'Bet√∂lt',
      previewTitle:'El≈ën√©zet', close:'Bez√°r',
      label:'C√≠mke', name:'N√©v (name)', placeholder:'Placeholder', help:'Seg√≠t≈ë sz√∂veg', required:'K√∂telez≈ë', colWidth:'Oszlopsz√©less√©g (1‚Äì12)',
      rows:'Sorok', min:'Min', max:'Max', step:'L√©p√©s', regex:'Regex minta (pattern)',
      options:'Opci√≥k', addOption:'Opci√≥', multiple:'T√∂bb kiv√°laszthat√≥', inline:'Egysoros (inline)', duplicate:'Duplik√°l', delete:'T√∂r√∂l',
      emptyHint:'H√∫zd be a mez≈ëket a bal oldali list√°b√≥l‚Ä¶', sectionTitle:'Szekci√≥ c√≠me', divider:'Elv√°laszt√≥',
      generatedWith:'Gener√°lva: FormBuilder (Bootstrap 5)', send:'K√ºld√©s', reset:'Reset',
      codeUpdated:'K√≥d friss√≠tve', copied:'V√°g√≥lapra m√°solva', jsonLoaded:'JSON bet√∂ltve', invalidJson:'Hib√°s JSON', confirmNew:'Biztosan √∫j ≈±rlapot kezdesz? A jelenlegi automatikusan ment√©sre ker√ºl.', newFormTitle:'√öj ≈±rlap', ajaxThanks:'K√∂sz√∂nj√ºk!',
      theme:'T√©ma', themeDefault:'Alap√©rtelmezett', themeGlass:'√úveges (glass)', themeSoft:'L√°gy (soft)', themeBorder:'K√∂rvonalas (bordered)', themeUnderline:'Al√°h√∫zott (underline)',
      types:{ text:'Sz√∂veg', email:'E-mail', password:'Jelsz√≥', number:'Sz√°m', textarea:'Sz√∂vegmez≈ë', select:'Select', radio:'R√°di√≥ csoport', checkbox:'Jel√∂l≈ë lista', switch:'Kapcsol√≥', date:'D√°tum', time:'Id≈ë', range:'Cs√∫szka', file:'F√°jl', heading:'C√≠msor', divider:'Elv√°laszt√≥' }
    },
    en: {
      appName:'FormBuilder', newBtn:'New', previewBtn:'Preview', generateBtn:'Generate',
      fields:'Fields', dragDrop:'Drag & Drop', formTitle:'Form title', action:'Action', method:'Method',
      ajaxSubmit:'AJAX submit', clientValidate:'Client-side validation', formEditor:'Form editor', sortHint:'Reorder: drag & drop ‚Ä¢ Click to edit',
      properties:'Properties', selectAField:'Select a field‚Ä¶', tabHtml:'HTML', tabJs:'JS', tabJson:'JSON', copy:'Copy', download:'Download', load:'Load',
      previewTitle:'Preview', close:'Close',
      label:'Label', name:'Name (name)', placeholder:'Placeholder', help:'Help text', required:'Required', colWidth:'Column width (1‚Äì12)',
      rows:'Rows', min:'Min', max:'Max', step:'Step', regex:'Regex pattern',
      options:'Options', addOption:'Add option', multiple:'Multiple', inline:'Inline', duplicate:'Duplicate', delete:'Delete',
      emptyHint:'Drag fields here from the left‚Ä¶', sectionTitle:'Section title', divider:'Divider',
      generatedWith:'Generated with FormBuilder (Bootstrap 5)', send:'Send', reset:'Reset',
      codeUpdated:'Code updated', copied:'Copied to clipboard', jsonLoaded:'JSON loaded', invalidJson:'Invalid JSON', confirmNew:'Start a new form? Current state is auto-saved.', newFormTitle:'New form', ajaxThanks:'Thank you!',
      theme:'Theme', themeDefault:'Default', themeGlass:'Glass', themeSoft:'Soft', themeBorder:'Bordered', themeUnderline:'Underline',
      types:{ text:'Text', email:'Email', password:'Password', number:'Number', textarea:'Textarea', select:'Select', radio:'Radio group', checkbox:'Checkbox list', switch:'Switch', date:'Date', time:'Time', range:'Range', file:'File', heading:'Heading', divider:'Divider' }
    },
    fr: {
      appName:'FormBuilder', newBtn:'Nouveau', previewBtn:'Aper√ßu', generateBtn:'G√©n√©rer',
      fields:'Champs', dragDrop:'Glisser-d√©poser', formTitle:'Titre du formulaire', action:'Action', method:'M√©thode',
      ajaxSubmit:'Envoi AJAX', clientValidate:'Validation c√¥t√© client', formEditor:'√âditeur de formulaire', sortHint:'R√©organiser : glisser-d√©poser ‚Ä¢ Cliquer pour modifier',
      properties:'Propri√©t√©s', selectAField:'S√©lectionnez un champ‚Ä¶', tabHtml:'HTML', tabJs:'JS', tabJson:'JSON', copy:'Copier', download:'T√©l√©charger', load:'Charger',
      previewTitle:'Aper√ßu', close:'Fermer',
      label:'Libell√©', name:'Nom (name)', placeholder:'Espace r√©serv√©', help:'Texte d‚Äôaide', required:'Obligatoire', colWidth:'Largeur de colonne (1‚Äì12)',
      rows:'Lignes', min:'Min', max:'Max', step:'Pas', regex:'Motif RegExp',
      options:'Options', addOption:'Ajouter', multiple:'Multiple', inline:'En ligne', duplicate:'Dupliquer', delete:'Supprimer',
      emptyHint:'Glissez des champs ici depuis la gauche‚Ä¶', sectionTitle:'Titre de section', divider:'S√©parateur',
      generatedWith:'G√©n√©r√© avec FormBuilder (Bootstrap 5)', send:'Envoyer', reset:'R√©initialiser',
      codeUpdated:'Code mis √† jour', copied:'Copi√©', jsonLoaded:'JSON charg√©', invalidJson:'JSON invalide', confirmNew:'Commencer un nouveau formulaire ? L‚Äô√©tat actuel est enregistr√©.', newFormTitle:'Nouveau formulaire', ajaxThanks:'Merci !',
      theme:'Th√®me', themeDefault:'Par d√©faut', themeGlass:'Glass', themeSoft:'Doux', themeBorder:'Bord√©', themeUnderline:'Soulign√©',
      types:{ text:'Texte', email:'E-mail', password:'Mot de passe', number:'Nombre', textarea:'Zone de texte', select:'S√©lection', radio:'Boutons radio', checkbox:'Cases √† cocher', switch:'Interrupteur', date:'Date', time:'Heure', range:'Curseur', file:'Fichier', heading:'Titre', divider:'S√©parateur' }
    },
    de: {
      appName:'FormBuilder', newBtn:'Neu', previewBtn:'Vorschau', generateBtn:'Generieren',
      fields:'Felder', dragDrop:'Ziehen & Ablegen', formTitle:'Formulartitel', action:'Action', method:'Methode',
      ajaxSubmit:'AJAX‚Äë√úbermittlung', clientValidate:'Client‚ÄëValidierung', formEditor:'Formular-Editor', sortHint:'Sortieren: Drag & Drop ‚Ä¢ Zum Bearbeiten klicken',
      properties:'Eigenschaften', selectAField:'Feld ausw√§hlen‚Ä¶', tabHtml:'HTML', tabJs:'JS', tabJson:'JSON', copy:'Kopieren', download:'Herunterladen', load:'Laden',
      previewTitle:'Vorschau', close:'Schlie√üen',
      label:'Bezeichnung', name:'Name (name)', placeholder:'Platzhalter', help:'Hilfetext', required:'Erforderlich', colWidth:'Spaltenbreite (1‚Äì12)',
      rows:'Zeilen', min:'Min', max:'Max', step:'Schritt', regex:'Regex-Muster',
      options:'Optionen', addOption:'Option', multiple:'Mehrfach', inline:'Inline', duplicate:'Duplizieren', delete:'L√∂schen',
      emptyHint:'Felder von links hierher ziehen‚Ä¶', sectionTitle:'Abschnittstitel', divider:'Trenner',
      generatedWith:'Generiert mit FormBuilder (Bootstrap 5)', send:'Senden', reset:'Zur√ºcksetzen',
      codeUpdated:'Code aktualisiert', copied:'In die Zwischenablage kopiert', jsonLoaded:'JSON geladen', invalidJson:'Ung√ºltiges JSON', confirmNew:'Neues Formular starten? Aktueller Zustand wird gespeichert.', newFormTitle:'Neues Formular', ajaxThanks:'Danke!',
      theme:'Thema', themeDefault:'Standard', themeGlass:'Glas', themeSoft:'Weich', themeBorder:'Gerahmt', themeUnderline:'Unterstrichen',
      types:{ text:'Text', email:'E-Mail', password:'Passwort', number:'Zahl', textarea:'Textbereich', select:'Auswahl', radio:'Radiogruppe', checkbox:'Kontrollk√§stchen', switch:'Schalter', date:'Datum', time:'Uhrzeit', range:'Bereich', file:'Datei', heading:'√úberschrift', divider:'Trenner' }
    }
  };
  let currentLang = localStorage.getItem('fb_lang') || 'hu';
  const t = (k) => (i18n[currentLang] && (i18n[currentLang][k] ?? k)) || (i18n.en[k] ?? k);
  const typeLabel = (type) => (i18n[currentLang]?.types?.[type]) || (i18n.en.types[type] || type);

  // ===== Helpers =====
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const toast = new bootstrap.Toast($('#toast'));
  const showToast = (msg) => { $('#toastBody').textContent = msg; toast.show(); };

  // ===== Palette defs =====
  const paletteDefs = [
    {type:'text',icon:'type'},{type:'email',icon:'envelope'},{type:'password',icon:'shield-lock'},{type:'number',icon:'123'},
    {type:'textarea',icon:'justify-left'},{type:'select',icon:'list-check'},{type:'radio',icon:'ui-radios'},{type:'checkbox',icon:'check2-square'},
    {type:'switch',icon:'toggle2-on'},{type:'date',icon:'calendar'},{type:'time',icon:'clock'},{type:'range',icon:'sliders'},
    {type:'file',icon:'paperclip'},{type:'heading',icon:'type-h1'},{type:'divider',icon:'hr'}
  ];

  // ===== State =====
  let form = { title:'Kapcsolatfelv√©tel', action:'', method:'POST', ajax:true, validate:true, theme:'default', fields:[] };
  let selectedId = null;

  // ===== i18n hydrate =====
  function applyI18nStatic(){
    document.documentElement.setAttribute('lang', currentLang);
    $$('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      el.textContent = t(key);
    });
  }

  // ===== Palette render =====
  function renderPalette(){
    const pal = $('#palette'); pal.innerHTML='';
    paletteDefs.forEach(def => {
      const col = document.createElement('div');
      col.className = 'col-6';
      col.innerHTML = `<div class="palette-item glass rounded p-2 text-center" data-type="${def.type}">
          <div class="fs-4"><i class="bi bi-${def.icon}"></i></div>
          <div class="small">${typeLabel(def.type)}</div>
        </div>`;
      pal.appendChild(col);
    });
  }

  // palette click
  $('#palette').addEventListener('click', e => {
    const item = e.target.closest('.palette-item');
    if(!item) return; addField(item.dataset.type);
  });

  // canvas sortable
  const canvas = $('#canvas');
  new Sortable(canvas, {
    animation: 150,
    handle: '.field-card',
    ghostClass: 'dragging',
    onEnd: () => {
      const ids = $$('#canvas .field-card').map(x => x.dataset.id);
      form.fields.sort((a,b) => ids.indexOf(a.id) - ids.indexOf(b.id));
      persist(); render();
    }
  });

  // helpers
  const uid = () => 'f' + Math.random().toString(36).slice(2,9);
  const defByType = (type) => ({
    id: uid(), type,
    label: type==='heading'?t('sectionTitle'):(type==='divider'?t('divider'):t('label')),
    name: (type==='heading'||type==='divider')?'':(type + '_' + Math.random().toString(36).slice(2,5)),
    placeholder: '', help: '', required: false, col: 12, rows: 3, pattern:'',
    min:'', max:'', step:'', inline:false, multiple:false,
    options: (type==='select'||type==='radio'||type==='checkbox') ? [
      {label:'Option 1', value:'option1'}, {label:'Option 2', value:'option2'}
    ] : []
  });

  function addField(type){
    const f = defByType(type);
    form.fields.push(f); selectedId = f.id; persist(); render(); showToast(typeLabel(type) + ' ‚úì');
  }
  function removeField(id){ const i=form.fields.findIndex(f=>f.id===id); if(i>-1){ form.fields.splice(i,1); if(selectedId===id) selectedId=null; persist(); render(); } }
  function cloneField(id){ const f=form.fields.find(x=>x.id===id); if(!f) return; const c=JSON.parse(JSON.stringify(f)); c.id=uid(); c.name=f.name?f.name+'_copy':''; form.fields.splice(form.fields.indexOf(f)+1,0,c); selectedId=c.id; persist(); render(); }
  function selectField(id){ selectedId=id; renderProps(); $(`#canvas [data-id="${id}"]`)?.scrollIntoView({block:'nearest'}); }

  // render
  function render(){ renderCanvas(); renderProps(); generate(false); applyI18nStatic(); renderPalette(); $('#formTheme').value=form.theme; }

  function renderCanvas(){
    canvas.innerHTML = '';
    if(!form.fields.length){
      const empty = document.createElement('div');
      empty.className = 'text-center text-secondary p-5';
      empty.innerHTML = `<i class="bi bi-mouse fs-1 d-block mb-2"></i><span>${t('emptyHint')}</span>`;
      canvas.appendChild(empty); return;
    }
    form.fields.forEach(f => {
      const wrap = document.createElement('div');
      wrap.className = 'field-card glass rounded p-2 mb-2';
      wrap.dataset.id = f.id;
      wrap.innerHTML = fieldCardHtml(f);
      wrap.addEventListener('click', () => selectField(f.id));
      wrap.querySelector('[data-act="del"]').addEventListener('click', (e)=>{ e.stopPropagation(); removeField(f.id); });
      wrap.querySelector('[data-act="clone"]').addEventListener('click', (e)=>{ e.stopPropagation(); cloneField(f.id); });
      canvas.appendChild(wrap);
    });
  }

  function fieldCardHtml(f){
    const badge = `<span class="badge text-bg-secondary">${typeLabel(f.type)}</span>`;
    return `<div class="d-flex align-items-start gap-2">
      <div class="w-36 text-center"><i class="bi bi-grip-vertical"></i></div>
      <div class="flex-grow-1">
        <div class="fw-semibold">${escapeHtml(f.label||'(' + t('label') + ')')} ${badge}</div>
        ${f.help?`<div class=\"text-secondary small\">${escapeHtml(f.help)}</div>`:''}
        <div class="small text-secondary">name=<code>${escapeHtml(f.name||'‚Äî')}</code> ‚Ä¢ col=${f.col}</div>
      </div>
      <div class="d-flex gap-1">
        <button class="btn btn-sm btn-outline-secondary" data-act="clone" title="${t('duplicate')}"><i class="bi bi-files"></i></button>
        <button class="btn btn-sm btn-outline-danger" data-act="del" title="${t('delete')}"><i class="bi bi-trash"></i></button>
      </div>
    </div>`
  }

  function renderProps(){
    $('#formTitle').value = form.title; $('#formAction').value = form.action; $('#formMethod').value = form.method; $('#ajaxSubmit').checked = form.ajax; $('#clientValidate').checked = form.validate; $('#formTheme').value=form.theme;
    if(!selectedId){ $('#propPanel').setAttribute('data-i18n','selectAField'); $('#propPanel').textContent=t('selectAField'); return; }
    const f = form.fields.find(x=>x.id===selectedId); if(!f){ $('#propPanel').innerHTML=''; return; }

    const common = `
      ${['heading','divider'].includes(f.type)?'':`
      <div class=\"mb-2\"><div class=\"prop-label\" data-i18n=\"name\">${t('name')}</div><input class=\"form-control\" id=\"prop-name\" value=\"${escapeAttr(f.name)}\"></div>
      <div class=\"mb-2\"><div class=\"prop-label\" data-i18n=\"placeholder\">${t('placeholder')}</div><input class=\"form-control\" id=\"prop-placeholder\" value=\"${escapeAttr(f.placeholder)}\"></div>
      <div class=\"mb-2\"><div class=\"prop-label\" data-i18n=\"required\">${t('required')}</div>
        <div class=\"form-check form-switch\"><input class=\"form-check-input\" id=\"prop-required\" type=\"checkbox\" ${f.required?'checked':''}></div>
      </div>
      `}
      <div class=\"mb-2\"><div class=\"prop-label\" data-i18n=\"label\">${t('label')}</div><input class=\"form-control\" id=\"prop-label\" value=\"${escapeAttr(f.label)}\"></div>
      <div class=\"mb-2\"><div class=\"prop-label\" data-i18n=\"help\">${t('help')}</div><input class=\"form-control\" id=\"prop-help\" value=\"${escapeAttr(f.help)}\"></div>
      <div class=\"mb-2\"><div class=\"prop-label\" data-i18n=\"colWidth\">${t('colWidth')}</div><input type=\"number\" min=\"1\" max=\"12\" class=\"form-control\" id=\"prop-col\" value=\"${f.col}\"></div>
    `;

    let specific = '';
    if(f.type==='textarea') specific += `<div class=\"mb-2\"><div class=\"prop-label\" data-i18n=\"rows\">${t('rows')}</div><input type=\"number\" min=\"1\" class=\"form-control\" id=\"prop-rows\" value=\"${f.rows}\"></div>`;
    if(['number','range'].includes(f.type)) specific += `
      <div class=\"row g-2\">
        <div class=\"col-4\"><div class=\"prop-label\" data-i18n=\"min\">${t('min')}</div><input id=\"prop-min\" class=\"form-control\" value=\"${escapeAttr(f.min)}\"></div>
        <div class=\"col-4\"><div class=\"prop-label\" data-i18n=\"max\">${t('max')}</div><input id=\"prop-max\" class=\"form-control\" value=\"${escapeAttr(f.max)}\"></div>
        <div class=\"col-4\"><div class=\"prop-label\" data-i18n=\"step\">${t('step')}</div><input id=\"prop-step\" class=\"form-control\" value=\"${escapeAttr(f.step)}\"></div>
      </div>`;
    if(['text','email','password'].includes(f.type)) specific += `<div class=\"mb-2\"><div class=\"prop-label\" data-i18n=\"regex\">${t('regex')}</div><input class=\"form-control\" id=\"prop-pattern\" value=\"${escapeAttr(f.pattern)}\" placeholder=\"^.{8,}$\"></div>`;
    if(['select','radio','checkbox'].includes(f.type)) specific += `
      <div class=\"mb-2 d-flex align-items-center justify-content-between\"><div class=\"prop-label m-0\" data-i18n=\"options\">${t('options')}</div>
        <button class=\"btn btn-sm btn-outline-secondary\" id=\"btn-add-option\"><i class=\"bi bi-plus\"></i> ${t('addOption')}</button>
      </div>
      <div id=\"optWrap\"></div>
      ${f.type==='select'?`<div class=\"form-check\"><input id=\"prop-multiple\" class=\"form-check-input\" type=\"checkbox\" ${f.multiple?'checked':''}><label class=\"form-check-label\" data-i18n=\"multiple\">${t('multiple')}</label></div>`:''}
      ${f.type!=='select'?`<div class=\"form-check\"><input id=\"prop-inline\" class=\"form-check-input\" type=\"checkbox\" ${f.inline?'checked':''}><label class=\"form-check-label\" data-i18n=\"inline\">${t('inline')}</label></div>`:''}
    `;
    if(f.type==='heading') specific += `<div class=\"text-secondary small\">${t('sectionTitle')}</div>`;

    $('#propPanel').innerHTML = common + specific + `<hr><div class=\"d-flex gap-2\">
      <button class=\"btn btn-sm btn-outline-secondary\" id=\"btn-dup\"><i class=\"bi bi-files\"></i> ${t('duplicate')}</button>
      <button class=\"btn btn-sm btn-outline-danger\" id=\"btn-del\"><i class=\"bi bi-trash\"></i> ${t('delete')}</button>
    </div>`;

    // bind
    const bind = (id,cb,ev='input') => { const el=$('#'+id); if(el) el.addEventListener(ev, cb); };
    bind('prop-label', e=>{ f.label=e.target.value; persist(); renderCanvas(); });
    bind('prop-name', e=>{ f.name=e.target.value; persist(); renderCanvas(); });
    bind('prop-placeholder', e=>{ f.placeholder=e.target.value; persist(); });
    bind('prop-help', e=>{ f.help=e.target.value; persist(); renderCanvas(); });
    bind('prop-col', e=>{ f.col=Math.max(1,Math.min(12,parseInt(e.target.value||12))); persist(); renderCanvas(); });
    bind('prop-required', e=>{ f.required=e.target.checked; persist(); });
    bind('prop-rows', e=>{ f.rows=parseInt(e.target.value||3); persist(); });
    bind('prop-min', e=>{ f.min=e.target.value; persist(); });
    bind('prop-max', e=>{ f.max=e.target.value; persist(); });
    bind('prop-step', e=>{ f.step=e.target.value; persist(); });
    bind('prop-pattern', e=>{ f.pattern=e.target.value; persist(); });
    const del=$('#btn-del'); if(del) del.addEventListener('click', ()=> removeField(f.id));
    const dup=$('#btn-dup'); if(dup) dup.addEventListener('click', ()=> cloneField(f.id));

    // options UI
    if(['select','radio','checkbox'].includes(f.type)){
      const wrap = $('#optWrap');
      const drawOpts = () => {
        wrap.innerHTML = '';
        f.options.forEach((o,idx)=>{
          const row = document.createElement('div');
          row.className = 'input-group input-group-sm mb-1';
          row.innerHTML = `
            <span class=\"input-group-text\">${idx+1}</span>
            <input class=\"form-control\" placeholder=\"Label\" value=\"${escapeAttr(o.label)}\" data-k=\"label\">
            <input class=\"form-control\" placeholder=\"Value\" value=\"${escapeAttr(o.value)}\" data-k=\"value\">
            <button class=\"btn btn-outline-danger\" data-k=\"del\"><i class=\"bi bi-x\"></i></button>`;
          row.querySelector('[data-k="label"]').addEventListener('input', e=>{ o.label=e.target.value; persist(); });
          row.querySelector('[data-k="value"]').addEventListener('input', e=>{ o.value=e.target.value; persist(); });
          row.querySelector('[data-k="del"]').addEventListener('click', ()=>{ f.options.splice(idx,1); persist(); drawOpts(); });
          wrap.appendChild(row);
        });
      };
      drawOpts();
      $('#btn-add-option').addEventListener('click', ()=>{ f.options.push({label:'New option', value:'new'}); persist(); drawOpts(); });
    }
  }

  // generation
  function generate(updateOutputs=true){
    const {html, js} = buildOutputs();
    if(updateOutputs){ $('#outHtml').value = html; $('#outJs').value = js; $('#outJson').value = JSON.stringify(form, null, 2); }
  }

  function themeCss(theme){
    const base = `#generatedForm .form-control,#generatedForm .form-select,#generatedForm .form-range{transition:.2s}`;
    const focus = `#generatedForm .form-control:focus,#generatedForm .form-select:focus{box-shadow:none}`;
    if(theme==='glass') return `${base}${focus}
#generatedForm.form-theme-glass{backdrop-filter:saturate(140%) blur(4px)}
#generatedForm.form-theme-glass .form-control,#generatedForm.form-theme-glass .form-select{background:rgba(255,255,255,.05);border-color:rgba(255,255,255,.2)}
#generatedForm.form-theme-glass .form-control:focus,#generatedForm.form-theme-glass .form-select:focus{background:rgba(255,255,255,.08);border-color:rgba(0,255,168,.6)}
#generatedForm.form-theme-glass .form-label{font-weight:600}`;
    if(theme==='soft') return `${base}${focus}
#generatedForm.form-theme-soft .form-control,#generatedForm.form-theme-soft .form-select{border-radius:1rem;border-color:#e9ecef}
#generatedForm.form-theme-soft .form-control:focus,#generatedForm.form-theme-soft .form-select:focus{border-color:#7b61ff;box-shadow:0 0 0 .2rem rgba(123,97,255,.15)}
#generatedForm.form-theme-soft .btn{border-radius:1rem}`;
    if(theme==='bordered') return `${base}${focus}
#generatedForm.form-theme-bordered .form-control,#generatedForm.form-theme-bordered .form-select{border:2px solid #dee2e6}
#generatedForm.form-theme-bordered .form-control:focus,#generatedForm.form-theme-bordered .form-select:focus{border-color:#0d6efd}
#generatedForm.form-theme-bordered .form-label{text-transform:uppercase;letter-spacing:.04em;font-size:.8rem}`;
    if(theme==='underline') return `${base}${focus}
#generatedForm.form-theme-underline .form-control,#generatedForm.form-theme-underline .form-select{border:0;border-bottom:2px solid #ced4da;border-radius:0;background:transparent}
#generatedForm.form-theme-underline .form-control:focus,#generatedForm.form-theme-underline .form-select:focus{border-bottom-color:#198754}
#generatedForm.form-theme-underline .form-label{font-weight:600}`;
    // default
    return `${base}${focus}`;
  }

  function buildOutputs(){
    const hasFile = form.fields.some(f=>f.type==='file');
    const needsEnctype = hasFile ? ' enctype="multipart/form-data"' : '';
    const novalidate = form.validate ? '' : ' novalidate';

    const rows = [];
    let rowOpen = false, colCount = 0;
    const pushRowOpen = () => { rows.push('<div class="row g-3">'); rowOpen=true; colCount=0; };
    const pushRowClose = () => { if(rowOpen){ rows.push('</div>'); rowOpen=false; colCount=0; } };

    form.fields.forEach(f => {
      if(f.type==='divider'){ pushRowClose(); rows.push('<hr class="my-3">'); return; }
      if(f.type==='heading'){ pushRowClose(); rows.push('<h5 class="mt-2">'+escapeHtml(f.label||t('sectionTitle'))+'</h5>'); return; }
      if(!rowOpen) pushRowOpen();
      rows.push('<div class="col-12 col-md-'+f.col+'">' + fieldControlHtml(f) + '</div>');
      colCount += f.col; if(colCount>=12){ pushRowClose(); }
    });
    pushRowClose();

   const submitRow = [
  '<div class="mt-3 d-flex gap-2">',
  '  <button class="btn btn-primary" type="submit"><i class="bi bi-send"></i> ' + t('send') + '</button>',
  '  <button class="btn btn-outline-secondary" type="reset"><i class="bi bi-arrow-counterclockwise"></i> ' + t('reset') + '</button>',
  '</div>'
].join('\n'); // ‚úÖ helyes: sz√≥ szerinti \n



    const themeClass = 'form-theme-' + form.theme;
    const styleCss = themeCss(form.theme);
    const rowsHtml = rows.join('');

    const html = `<!-- ===== ${t('generatedWith')} ===== -->
`
      + `<style>${styleCss}</style>
`
      + `<form id="generatedForm" class="${themeClass}" action="${escapeAttr(form.action)}" method="${escapeAttr(form.method)}"${needsEnctype}${novalidate}>
`
      + `  <h4 class="mb-3">${escapeHtml(form.title)}</h4>
`
      + `  ${rowsHtml}
`
      + `  ${submitRow}
`
      + `</form>`;

    const js = form.ajax ? [
      "// AJAX submit example (fetch + JSON response)",
      "(function(){",
      "  var formEl = document.getElementById('generatedForm');",
      "  formEl.addEventListener('submit', async function(e){",
      "    e.preventDefault();",
      "    var fd = new FormData(formEl);",
      "    var res = await fetch(formEl.action||'/req/submit.php', { method: formEl.method||'POST', body: fd });",
      "    var type = (res.headers.get('content-type')||'');",
      "    var data = type.indexOf('application/json')>-1 ? await res.json() : await res.text();",
      "    console.log('Response:', data);",
      "    alert('" + t('ajaxThanks').replace(/'/g, "\'") + "');",
      "  });",
      "})();"
    ].join('') : "// AJAX disabled - default browser submission.";

    return { html, js };
  }

  function fieldControlHtml(f){
    const req = f.required ? ' required' : '';
    const help = f.help ? `<div class=\"form-text\">${escapeHtml(f.help)}</div>` : '';
    const commonAttr = `${f.placeholder?` placeholder=\"${escapeAttr(f.placeholder)}\"`:''}${f.pattern?` pattern=\"${escapeAttr(f.pattern)}\"`:''}${req}`;

    if(f.type==='textarea') return `
      <label class=\"form-label\">${escapeHtml(f.label||typeLabel('textarea'))}</label>
      <textarea class=\"form-control\" name=\"${escapeAttr(f.name)}\" rows=\"${f.rows}\"${commonAttr}></textarea>
      ${help}`;
    if(['text','email','password','date','time','number'].includes(f.type)) return `
      <label class=\"form-label\">${escapeHtml(f.label||typeLabel(f.type))}</label>
      <input class=\"form-control\" type=\"${f.type}\" name=\"${escapeAttr(f.name)}\"${f.min?` min=\"${escapeAttr(f.min)}\"`:''}${f.max?` max=\"${escapeAttr(f.max)}\"`:''}${f.step?` step=\"${escapeAttr(f.step)}\"`:''}${commonAttr}>
      ${help}`;
    if(f.type==='range') return `
      <label class=\"form-label\">${escapeHtml(f.label||typeLabel('range'))}</label>
      <input class=\"form-range\" type=\"range\" name=\"${escapeAttr(f.name)}\"${f.min?` min=\"${escapeAttr(f.min)}\"`:''}${f.max?` max=\"${escapeAttr(f.max)}\"`:''}${f.step?` step=\"${escapeAttr(f.step)}\"`:''}${req}>
      ${help}`;
    if(f.type==='file') return `
      <label class=\"form-label\">${escapeHtml(f.label||typeLabel('file'))}</label>
      <input class=\"form-control\" type=\"file\" name=\"${escapeAttr(f.name)}\"${req}>
      ${help}`;
    if(f.type==='select') return `
      <label class=\"form-label\">${escapeHtml(f.label||typeLabel('select'))}</label>
      <select class=\"form-select\" name=\"${escapeAttr(f.name)}\"${f.multiple?' multiple':''}${req}>
        ${f.options.map(o=>`<option value=\"${escapeAttr(o.value)}\">${escapeHtml(o.label)}</option>`).join('')}
      </select>
      ${help}`;
    if(f.type==='radio') return `
      <div class=\"form-label\">${escapeHtml(f.label||typeLabel('radio'))}</div>
      <div class=\"${f.inline?'d-flex gap-3 flex-wrap':''}\">
        ${f.options.map((o,idx)=>`<div class=\"form-check${f.inline?' form-check-inline':''}\">
            <input class=\"form-check-input\" type=\"radio\" name=\"${escapeAttr(f.name)}\" id=\"${f.id}_${idx}\" value=\"${escapeAttr(o.value)}\"${req}>
            <label class=\"form-check-label\" for=\"${f.id}_${idx}\">${escapeHtml(o.label)}</label>
          </div>`).join('')}
      </div>
      ${help}`;
    if(f.type==='checkbox') return `
      <div class=\"form-label\">${escapeHtml(f.label||typeLabel('checkbox'))}</div>
      <div class=\"${f.inline?'d-flex gap-3 flex-wrap':''}\">
        ${f.options.map((o,idx)=>`<div class=\"form-check${f.inline?' form-check-inline':''}\">
            <input class=\"form-check-input\" type=\"checkbox\" name=\"${escapeAttr(f.name)}[]\" id=\"${f.id}_${idx}\" value=\"${escapeAttr(o.value)}\"${req}>
            <label class=\"form-check-label\" for=\"${f.id}_${idx}\">${escapeHtml(o.label)}</label>
          </div>`).join('')}
      </div>
      ${help}`;
    if(f.type==='switch') return `
      <div class=\"form-check form-switch\">
        <input class=\"form-check-input\" type=\"checkbox\" role=\"switch\" name=\"${escapeAttr(f.name)}\" id=\"${f.id}\"${req}>
        <label class=\"form-check-label\" for=\"${f.id}\">${escapeHtml(f.label||typeLabel('switch'))}</label>
      </div>
      ${help}`;
    return `<div class=\"text-secondary small\">(Unknown: ${escapeHtml(f.type)})</div>`;
  }

  // escape helpers
  function escapeHtml(s=''){ return s.replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
  function escapeAttr(s=''){ return s.replace(/[&<>\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c])); }

  // form-level bindings
  $('#formTitle').addEventListener('input', e=>{ form.title=e.target.value; persist(); });
  $('#formAction').addEventListener('input', e=>{ form.action=e.target.value; persist(); });
  $('#formMethod').addEventListener('change', e=>{ form.method=e.target.value; persist(); });
  $('#ajaxSubmit').addEventListener('change', e=>{ form.ajax=e.target.checked; generate(); persist(); });
  $('#clientValidate').addEventListener('change', e=>{ form.validate=e.target.checked; generate(); persist(); });
  $('#formTheme').addEventListener('change', e=>{ form.theme=e.target.value; generate(); persist(); });

  // theme (dark/light of app)
  $('#themeSwitch').checked = (document.documentElement.getAttribute('data-bs-theme')==='dark');
  $('#themeSwitch').addEventListener('change', e=>{
    document.documentElement.setAttribute('data-bs-theme', e.target.checked?'dark':'light');
    localStorage.setItem('fb_theme', e.target.checked?'dark':'light');
  });
  const savedTheme = localStorage.getItem('fb_theme');
  if(savedTheme) document.documentElement.setAttribute('data-bs-theme', savedTheme);

  // language switch
  const langSelect = $('#langSelect'); langSelect.value=currentLang;
  langSelect.addEventListener('change', ()=>{ currentLang = langSelect.value; localStorage.setItem('fb_lang', currentLang); applyI18nStatic(); renderPalette(); render(); });

  // preview (safe script injection)
  $('#btn-preview').addEventListener('click', ()=>{
    const {html, js} = buildOutputs();
    const mount = document.getElementById('previewMount');
    mount.innerHTML = html;
    const s = document.createElement('script'); s.type='text/javascript'; s.textContent = js; mount.appendChild(s);
    new bootstrap.Modal(document.getElementById('previewModal')).show();
  });

  // generate & copy
  $('#btn-generate').addEventListener('click', ()=>{ generate(); showToast(t('codeUpdated')); });
  const copy = (id)=>{ navigator.clipboard.writeText($(id).value).then(()=>showToast(t('copied'))); };
  $('#copyHtml').addEventListener('click', ()=>copy('#outHtml'));
  $('#copyJs').addEventListener('click', ()=>copy('#outJs'));
  $('#copyJson').addEventListener('click', ()=>copy('#outJson'));
  $('#downloadHtml').addEventListener('click', ()=> download('form.html', $('#outHtml').value));
  $('#downloadJson').addEventListener('click', ()=> download('form.json', $('#outJson').value));
  $('#loadJson').addEventListener('click', async ()=>{
    const txt = $('#outJson').value.trim(); if(!txt) return;
    try{ const obj = JSON.parse(txt); form = obj; selectedId=null; persist(); render(); showToast(t('jsonLoaded')); }
    catch(e){ showToast(t('invalidJson')); }
  });

  function download(filename, text){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([text], {type: 'text/plain'}));
    a.download = filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  }

  // new form
  $('#btn-new').addEventListener('click', ()=>{
    if(confirm(t('confirmNew'))){
      form = { title: t('newFormTitle'), action:'', method:'POST', ajax:true, validate:true, theme:'default', fields:[] };
      selectedId=null; persist(); render();
    }
  });

  // persistence
  function persist(){ localStorage.setItem('formBuilderState', JSON.stringify(form)); }
  function revive(){
    const raw = localStorage.getItem('formBuilderState');
    if(raw){ try{ const obj = JSON.parse(raw); if(obj && obj.fields){ form = obj; if(!form.theme) form.theme='default'; } }catch(e){} }
  }

  // boot
  revive();
  applyI18nStatic();
  renderPalette();
  render();
})();
</script>
</body>
</html>
